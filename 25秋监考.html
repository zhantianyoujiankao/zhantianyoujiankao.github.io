<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜æ ¡ç›‘è€ƒè‡ªåŠ¨æ’è€ƒç³»ç»Ÿ</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #f8f9fa;
            --dark: #343a40;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            width: 95%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), #2980b9);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1, h2, h3 {
            margin-bottom: 0.5rem;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f8f9fa;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background: white;
            border: 2px solid #ddd;
            border-bottom: none;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .teacher-list, .exam-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .teacher-item, .exam-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .teacher-item:last-child, .exam-item:last-child {
            border-bottom: none;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .badge-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .badge-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .badge-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .badge-success {
            background-color: var(--secondary);
            color: white;
        }
        
        .badge-tomorrow {
            background-color: #ff6b6b;
            color: white;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .alert {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .flex-row {
            display: flex;
            gap: 15px;
        }
        
        .flex-row > div {
            flex: 1;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
        }
        
        .checkbox-item input {
            width: auto;
            margin-right: 8px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .close {
            font-size: 24px;
            cursor: pointer;
        }
        
        .replacement-section {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .option-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .option-item:hover {
            background-color: #f0f0f0;
        }
        
        .option-item.selected {
            background-color: #e3f2fd;
            border-color: var(--primary);
        }
        
        .replacement-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .replacement-tab {
            padding: 8px 15px;
            cursor: pointer;
        }
        
        .replacement-tab.active {
            border-bottom: 2px solid var(--primary);
            font-weight: bold;
        }
        
        .replacement-content {
            display: none;
        }
        
        .replacement-content.active {
            display: block;
        }
        
        .manual-select {
            margin-top: 15px;
        }
        
        .manual-select select {
            margin-top: 10px;
        }
        
        .teacher-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .export-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .export-card h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .export-card p {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        /* é¦–å­—æ¯ç´¢å¼•æ ·å¼ */
        .alphabet-index {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .alphabet-letter {
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
            background-color: #e9ecef;
            font-size: 14px;
            min-width: 24px;
            text-align: center;
        }
        
        .alphabet-letter:hover {
            background-color: #dee2e6;
        }
        
        .alphabet-letter.active {
            background-color: var(--primary);
            color: white;
        }
        
        .teacher-group {
            margin-bottom: 15px;
        }
        
        .group-header {
            padding: 5px 0;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--primary);
            border-bottom: 1px solid #eee;
        }
        
        .search-box {
            margin-bottom: 10px;
        }
        
        .date-note {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .past-exam-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .tomorrow-exam-notice {
            background-color: #ffeaa7;
            border: 1px solid #fdcb6e;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #e17055;
        }
        
        .query-results {
            margin-top: 20px;
        }
        
        .query-section {
            margin-bottom: 30px;
        }
        
        .teacher-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .exam-record {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .exam-record h4 {
            margin-bottom: 5px;
            color: #333;
        }
        
        .exam-record p {
            margin: 3px 0;
            color: #666;
        }
        
        .teacher-count-badge {
            display: inline-block;
            background-color: var(--secondary);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .teacher-count-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .teacher-count-info {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }
        
        .teacher-count-info h3 {
            margin-bottom: 10px;
            color: #1976d2;
        }
        
        .teacher-count-info p {
            margin: 5px 0;
            color: #555;
        }
        
        /* å¤‡ä»½æ¢å¤ç›¸å…³æ ·å¼ */
        .backup-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        .backup-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .backup-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .backup-card h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .backup-card p {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: block;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border: 1px dashed #ddd;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
        }
        
        .file-input-label:hover {
            background-color: #e9ecef;
        }
        
        .backup-preview {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .backup-preview h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .backup-preview-item {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }
        
        .backup-preview-item:last-child {
            border-bottom: none;
        }
        
        /* æ›¿æ¢å†å²è®°å½•æ ·å¼ */
        .replacement-history {
            margin-top: 20px;
        }
        
        .history-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }
        
        .history-item h4 {
            margin-bottom: 5px;
            color: #333;
        }
        
        .history-item p {
            margin: 3px 0;
            color: #666;
        }
        
        /* æ›¿æ¢åŸå› è¾“å…¥æ¡†æ ·å¼ */
        .replacement-reason {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        /* éƒ¨é—¨è¾“å…¥æ ·å¼ */
        .department-input {
            margin-bottom: 15px;
        }
        
        /* å­¦æœŸé€‰æ‹©é¡µé¢æ ·å¼ */
        .semester-selection {
            text-align: center;
            padding: 40px 20px;
        }
        
        .semester-card {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .semester-card h2 {
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .semester-card p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .current-semester-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--secondary), #27ae60);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 20px;
        }
        
        /* æ–°å¢æ ·å¼ï¼šå·²é€‰æ•™å¸ˆæ ‡ç­¾ */
        .selected-teachers {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            min-height: 50px;
        }
        
        .selected-teacher-tag {
            display: inline-flex;
            align-items: center;
            background-color: var(--primary);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .selected-teacher-tag .remove {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .flex-row {
                flex-direction: column;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr 1fr;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                margin-bottom: 5px;
            }
            
            .export-options {
                grid-template-columns: 1fr;
            }
            
            .alphabet-index {
                gap: 3px;
            }
            
            .alphabet-letter {
                padding: 3px 6px;
                font-size: 12px;
                min-width: 20px;
            }
            
            .teacher-stats {
                grid-template-columns: 1fr;
            }
            
            .teacher-count-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .teacher-count-badge {
                margin-left: 0;
                margin-top: 10px;
            }
            
            .backup-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>é«˜æ ¡ç›‘è€ƒè‡ªåŠ¨æ’è€ƒç³»ç»Ÿ</h1>
            <p>ç®€åŒ–ç›‘è€ƒå®‰æ’æµç¨‹ï¼Œå®ç°å…¬å¹³åˆç†çš„ç›‘è€ƒåˆ†é…</p>
        </header>

        <div class="tab-container">
            <div class="tabs">
                <div class="tab active" data-tab="semester">å­¦æœŸé€‰æ‹©</div>
                <div class="tab" data-tab="teachers">æ•™å¸ˆç®¡ç†</div>
                <div class="tab" data-tab="exam-arrangement">ç›‘è€ƒå®‰æ’</div>
                <div class="tab" data-tab="exam-list">ç›‘è€ƒä»»åŠ¡</div>
                <div class="tab" data-tab="query">æ•°æ®æŸ¥è¯¢</div>
                <div class="tab" data-tab="export">æ•°æ®å¯¼å‡º</div>
            </div>

            <!-- å­¦æœŸé€‰æ‹© -->
            <div class="tab-content active" id="semester">
                <div class="semester-selection">
                    <div class="semester-card">
                        <h2>é€‰æ‹©å­¦æœŸ</h2>
                        <p>è¯·é€‰æ‹©è¦ç®¡ç†çš„å­¦æœŸï¼Œæ¯ä¸ªå­¦æœŸçš„æ•°æ®ç‹¬ç«‹å­˜å‚¨ï¼Œäº’ä¸å½±å“</p>
                        
                        <div class="form-group">
                            <label for="semester-select">é€‰æ‹©å­¦æœŸ</label>
                            <select id="semester-select">
                                <option value="25ç§‹">2025å¹´ç§‹å­£å­¦æœŸ</option>
                                <option value="26æ˜¥">2026å¹´æ˜¥å­£å­¦æœŸ</option>
                                <option value="26ç§‹">2026å¹´ç§‹å­£å­¦æœŸ</option>
                                <option value="27æ˜¥">2027å¹´æ˜¥å­£å­¦æœŸ</option>
                                <option value="27ç§‹">2027å¹´ç§‹å­£å­¦æœŸ</option>
                                <option value="28æ˜¥">2028å¹´æ˜¥å­£å­¦æœŸ</option>
                                <option value="28ç§‹">2028å¹´ç§‹å­£å­¦æœŸ</option>
                                <option value="29æ˜¥">2029å¹´æ˜¥å­£å­¦æœŸ</option>
                                <option value="29ç§‹">2029å¹´ç§‹å­£å­¦æœŸ</option>
                                <option value="30æ˜¥">2030å¹´æ˜¥å­£å­¦æœŸ</option>
                            </select>
                        </div>
                        
                        <button class="btn-primary" onclick="selectSemester()">è¿›å…¥ç³»ç»Ÿ</button>
                        
                        <div id="current-semester-info" class="current-semester-badge" style="display: none;">
                            å½“å‰å­¦æœŸ: <span id="current-semester-name"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ•™å¸ˆç®¡ç† -->
            <div class="tab-content" id="teachers">
                <div class="card">
                    <h2>æ•™å¸ˆåº“ç®¡ç† - <span id="semester-indicator"></span></h2>
                    
                    <!-- æ•™å¸ˆåº“ç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="teacher-count-info">
                        <h3>æ•™å¸ˆåº“ç»Ÿè®¡</h3>
                        <p><strong>æ•™å¸ˆæ€»æ•°ï¼š</strong><span id="teacher-total-count">0</span> äºº</p>
                        <p><strong>æœ‰ç›‘è€ƒè®°å½•æ•™å¸ˆï¼š</strong><span id="teacher-with-records-count">0</span> äºº</p>
                        <p><strong>æ— ç›‘è€ƒè®°å½•æ•™å¸ˆï¼š</strong><span id="teacher-without-records-count">0</span> äºº</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="teacher-names">æ·»åŠ æ•™å¸ˆï¼ˆæ¯è¡Œä¸€ä¸ªå§“åï¼‰</label>
                        <textarea id="teacher-names" rows="5" placeholder="è¯·è¾“å…¥æ•™å¸ˆå§“åï¼Œæ¯è¡Œä¸€ä¸ª"></textarea>
                    </div>
                    <button class="btn-primary" onclick="addTeachers()">æ‰¹é‡æ·»åŠ æ•™å¸ˆ</button>
                    <button class="btn-danger" onclick="clearTeachers()">æ¸…ç©ºæ•™å¸ˆåº“</button>
                </div>

                <div class="card">
                    <div class="teacher-count-header">
                        <h2>æ•™å¸ˆåˆ—è¡¨</h2>
                        <div class="teacher-count-badge">å…± <span id="teacher-list-count">0</span> åæ•™å¸ˆ</div>
                    </div>
                    <div class="teacher-list" id="teachers-container">
                        <!-- æ•™å¸ˆåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- æ•°æ®å¤‡ä»½ä¸æ¢å¤ -->
                <div class="card backup-section">
                    <h2>æ•°æ®å¤‡ä»½ä¸æ¢å¤</h2>
                    <div class="backup-options">
                        <div class="backup-card">
                            <h3>å¤‡ä»½æ•°æ®</h3>
                            <p>å°†ç³»ç»Ÿæ‰€æœ‰æ•°æ®ï¼ˆæ•™å¸ˆä¿¡æ¯ã€ç›‘è€ƒä»»åŠ¡ï¼‰å¯¼å‡ºä¸ºJSONæ–‡ä»¶ï¼Œç”¨äºæ•°æ®å¤‡ä»½æˆ–è¿ç§»</p>
                            <button class="btn-primary" onclick="backupData()">å¤‡ä»½æ•°æ®</button>
                        </div>
                        
                        <div class="backup-card">
                            <h3>æ¢å¤æ•°æ®</h3>
                            <p>ä»JSONå¤‡ä»½æ–‡ä»¶æ¢å¤ç³»ç»Ÿæ•°æ®ï¼Œå°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®</p>
                            <div class="file-input-wrapper">
                                <input type="file" id="restore-file" accept=".json" onchange="previewRestoreData()">
                                <label for="restore-file" class="file-input-label">é€‰æ‹©å¤‡ä»½æ–‡ä»¶</label>
                            </div>
                            <div id="restore-preview" class="backup-preview" style="display: none;">
                                <!-- å¤‡ä»½é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>
                            <button class="btn-warning" id="restore-btn" onclick="restoreData()" disabled>æ¢å¤æ•°æ®</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç›‘è€ƒå®‰æ’ -->
            <div class="tab-content" id="exam-arrangement">
                <div class="card">
                    <div class="teacher-count-header">
                        <h2>æ–°å»ºç›‘è€ƒä»»åŠ¡ - <span id="semester-indicator-arrangement"></span></h2>
                        <div class="teacher-count-badge">å¯ç”¨æ•™å¸ˆ: <span id="available-teachers-count">0</span>/<span id="total-teachers-count">0</span></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="exam-department">è€ƒè¯•éƒ¨é—¨</label>
                        <input type="text" id="exam-department" placeholder="è¯·è¾“å…¥è€ƒè¯•éƒ¨é—¨ï¼Œå¦‚ï¼šè®¡ç®—æœºå­¦é™¢">
                    </div>
                    
                    <div class="form-group">
                        <label for="exam-name">è€ƒè¯•åç§°</label>
                        <input type="text" id="exam-name" placeholder="è¯·è¾“å…¥è€ƒè¯•åç§°">
                    </div>
                    
                    <div class="form-group">
                        <label>ä»»è¯¾æ•™å¸ˆï¼ˆå¯é€‰ï¼Œå¯å¤šé€‰ï¼‰</label>
                        <!-- å·²é€‰æ•™å¸ˆæ˜¾ç¤ºåŒºåŸŸ -->
                        <div class="selected-teachers" id="selected-course-teachers">
                            <!-- å·²é€‰æ•™å¸ˆæ ‡ç­¾å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <div class="alphabet-index" id="course-teachers-index"></div>
                        <div class="search-box">
                            <input type="text" id="course-teachers-search" placeholder="æœç´¢æ•™å¸ˆ..." oninput="filterTeachers('course-teachers', this.value)">
                        </div>
                        <div class="checkbox-group" id="course-teachers">
                            <!-- æ•™å¸ˆå¤é€‰æ¡†å°†åŠ¨æ€æ·»åŠ  -->
                        </div>
                    </div>
                    
                    <div class="flex-row">
                        <div class="form-group">
                            <label for="campus">æ ¡åŒº</label>
                            <select id="campus">
                                <option value="æœ¬éƒ¨">æœ¬éƒ¨</option>
                                <option value="æ—…é¡º">æ—…é¡ºæ ¡åŒº</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="exam-date">è€ƒè¯•æ—¥æœŸ</label>
                            <input type="date" id="exam-date">
                            <div class="date-note">å¯ä»¥é€‰æ‹©è¿‡å»ã€ç°åœ¨æˆ–å°†æ¥çš„æ—¥æœŸ</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="invigilator-count">ç›‘è€ƒäººæ•°ï¼ˆåŒ…æ‹¬ä»»è¯¾æ•™å¸ˆï¼‰</label>
                        <input type="number" id="invigilator-count" min="1" value="2">
                    </div>
                    
                    <button class="btn-primary" onclick="arrangeInvigilation()">è‡ªåŠ¨æ’è€ƒ</button>
                </div>
            </div>

            <!-- ç›‘è€ƒä»»åŠ¡ -->
            <div class="tab-content" id="exam-list">
                <div class="card">
                    <h2>ç›‘è€ƒä»»åŠ¡åˆ—è¡¨ - <span id="semester-indicator-exams"></span></h2>
                    <div class="form-group">
                        <label for="exam-filter-date">æŒ‰æ—¥æœŸç­›é€‰</label>
                        <input type="date" id="exam-filter-date" onchange="filterExamsByDate()">
                        <button class="btn-secondary" onclick="clearExamFilter()">æ¸…é™¤ç­›é€‰</button>
                    </div>
                    
                    <!-- ç¬¬äºŒå¤©è€ƒè¯•æé†’ -->
                    <div id="tomorrow-exams-notice" class="tomorrow-exam-notice" style="display: none;">
                        <h4>ğŸ“¢ æ˜æ—¥è€ƒè¯•æé†’</h4>
                        <p>ä»¥ä¸‹è€ƒè¯•å°†åœ¨æ˜å¤©è¿›è¡Œï¼Œè¯·ç›¸å…³ç›‘è€ƒæ•™å¸ˆåšå¥½å‡†å¤‡ï¼š</p>
                        <div id="tomorrow-exams-list"></div>
                    </div>
                    
                    <div id="exams-container">
                        <!-- ç›‘è€ƒä»»åŠ¡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- æ•°æ®æŸ¥è¯¢ -->
            <div class="tab-content" id="query">
                <div class="card">
                    <div class="teacher-count-header">
                        <h2>æ•°æ®æŸ¥è¯¢ - <span id="semester-indicator-query"></span></h2>
                        <div class="teacher-count-badge">æ•™å¸ˆåº“: <span id="query-teacher-count">0</span> äºº</div>
                    </div>
                    
                    <!-- æ•™å¸ˆç›‘è€ƒè®°å½•æŸ¥è¯¢ -->
                    <div class="query-section">
                        <h3>æ•™å¸ˆç›‘è€ƒè®°å½•æŸ¥è¯¢</h3>
                        <div class="form-group">
                            <label>é€‰æ‹©æ•™å¸ˆ</label>
                            <div class="alphabet-index" id="query-teachers-index"></div>
                            <div class="search-box">
                                <input type="text" id="query-teachers-search" placeholder="æœç´¢æ•™å¸ˆ..." oninput="filterQueryTeachers(this.value)">
                            </div>
                            <select id="query-teacher-select" onchange="queryTeacherRecords()">
                                <option value="">-- è¯·é€‰æ‹©æ•™å¸ˆ --</option>
                                <!-- æ•™å¸ˆé€‰é¡¹å°†åŠ¨æ€æ·»åŠ  -->
                            </select>
                        </div>
                        
                        <div id="teacher-query-results" class="query-results">
                            <!-- æ•™å¸ˆæŸ¥è¯¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                    
                    <!-- è¯¾ç¨‹ç›‘è€ƒå®‰æ’æŸ¥è¯¢ -->
                    <div class="query-section">
                        <h3>è¯¾ç¨‹ç›‘è€ƒå®‰æ’æŸ¥è¯¢</h3>
                        <div class="form-group">
                            <label>æœç´¢è¯¾ç¨‹åç§°</label>
                            <input type="text" id="query-exam-name" placeholder="è¾“å…¥è¯¾ç¨‹åç§°æˆ–å…³é”®è¯" oninput="queryExamArrangements()">
                        </div>
                        
                        <div id="exam-query-results" class="query-results">
                            <!-- è¯¾ç¨‹æŸ¥è¯¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                    
                    <!-- éƒ¨é—¨ç›‘è€ƒå®‰æ’æŸ¥è¯¢ -->
                    <div class="query-section">
                        <h3>éƒ¨é—¨ç›‘è€ƒå®‰æ’æŸ¥è¯¢</h3>
                        <div class="form-group">
                            <label>æœç´¢éƒ¨é—¨åç§°</label>
                            <input type="text" id="query-department" placeholder="è¾“å…¥éƒ¨é—¨åç§°æˆ–å…³é”®è¯" oninput="queryDepartmentExams()">
                        </div>
                        
                        <div id="department-query-results" class="query-results">
                            <!-- éƒ¨é—¨æŸ¥è¯¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®å¯¼å‡º -->
            <div class="tab-content" id="export">
                <div class="card">
                    <div class="teacher-count-header">
                        <h2>å¯¼å‡ºæ•°æ® - <span id="semester-indicator-export"></span></h2>
                        <div class="teacher-count-badge">æ•™å¸ˆåº“: <span id="export-teacher-count">0</span> äºº</div>
                    </div>
                    <div class="export-options">
                        <div class="export-card">
                            <h3>å¯¼å‡ºç›‘è€ƒæ•°æ®</h3>
                            <p>å¯¼å‡ºæ‰€æœ‰ç›‘è€ƒä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç›‘è€ƒæ•™å¸ˆã€è€ƒè¯•éƒ¨é—¨ã€è€ƒè¯•åç§°ã€è€ƒè¯•æ—¥æœŸã€æ ¡åŒºä»¥åŠæ•™å¸ˆçš„ç›‘è€ƒç»Ÿè®¡</p>
                            <button class="btn-primary" onclick="exportExamData()">å¯¼å‡ºç›‘è€ƒæ•°æ®</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ›¿æ¢ç›‘è€ƒæ•™å¸ˆæ¨¡æ€æ¡† -->
    <div class="modal" id="replaceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ›¿æ¢ç›‘è€ƒæ•™å¸ˆ</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div>
                <p>è€ƒè¯•: <span id="modal-exam-name"></span></p>
                <p>éƒ¨é—¨: <span id="modal-exam-department"></span></p>
                <p>æ—¥æœŸ: <span id="modal-exam-date"></span></p>
                <p>æ ¡åŒº: <span id="modal-exam-campus"></span></p>
                
                <div id="past-exam-warning" class="past-exam-warning" style="display: none;">
                    æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªå·²ç»“æŸçš„è€ƒè¯•ï¼Œæ›¿æ¢æ•™å¸ˆå°†æ›´æ–°å†å²ç›‘è€ƒè®°å½•ã€‚
                </div>
                
                <div class="form-group">
                    <label>é€‰æ‹©è¦æ›¿æ¢çš„æ•™å¸ˆ</label>
                    <div class="alphabet-index" id="replace-teachers-index"></div>
                    <div class="checkbox-group" id="replace-teachers">
                        <!-- è¦æ›¿æ¢çš„æ•™å¸ˆå¤é€‰æ¡†å°†åŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
                
                <div class="replacement-tabs">
                    <div class="replacement-tab active" data-tab="recommended">æ¨èæ•™å¸ˆ</div>
                    <div class="replacement-tab" data-tab="manual">æŒ‡å®šæ•™å¸ˆ</div>
                </div>
                
                <div class="replacement-content active" id="recommended-content">
                    <div class="form-group">
                        <label>æ¨èæ›¿ä»£æ•™å¸ˆ</label>
                        <div id="replacement-options">
                            <!-- æ›¿ä»£æ•™å¸ˆé€‰é¡¹å°†åŠ¨æ€æ·»åŠ  -->
                        </div>
                    </div>
                </div>
                
                <div class="replacement-content" id="manual-content">
                    <div class="form-group">
                        <label>æ‰‹åŠ¨é€‰æ‹©æ›¿ä»£æ•™å¸ˆ</label>
                        <!-- å·²é€‰æ•™å¸ˆæ˜¾ç¤ºåŒºåŸŸ -->
                        <div class="selected-teachers" id="selected-manual-teachers">
                            <!-- å·²é€‰æ•™å¸ˆæ ‡ç­¾å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <div class="alphabet-index" id="manual-teachers-index"></div>
                        <div class="search-box">
                            <input type="text" id="manual-teachers-search" placeholder="æœç´¢æ•™å¸ˆ..." oninput="filterTeachers('manual-teachers', this.value)">
                        </div>
                        <div class="checkbox-group" id="manual-teachers">
                            <!-- æ•™å¸ˆå¤é€‰æ¡†å°†åŠ¨æ€æ·»åŠ  -->
                        </div>
                    </div>
                </div>
                
                <!-- æ›¿æ¢åŸå› éƒ¨åˆ† -->
                <div class="replacement-reason">
                    <div class="form-group">
                        <label for="replacement-reason">æ›¿æ¢åŸå› </label>
                        <textarea id="replacement-reason" rows="3" placeholder="è¯·ç®€è¦è¯´æ˜æ›¿æ¢åŸå› ..."></textarea>
                    </div>
                </div>
                
                <!-- æ›¿æ¢å†å²è®°å½• -->
                <div class="replacement-history" id="replacement-history" style="display: none;">
                    <h4>æ›¿æ¢å†å²è®°å½•</h4>
                    <div id="replacement-history-list">
                        <!-- æ›¿æ¢å†å²å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn-primary" onclick="confirmReplacement()">ç¡®è®¤æ›¿æ¢</button>
                    <button class="btn-danger" onclick="closeModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹æ›¿æ¢è®°å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç›‘è€ƒæ›¿æ¢è®°å½•</h3>
                <span class="close" onclick="closeHistoryModal()">&times;</span>
            </div>
            <div>
                <p>è€ƒè¯•: <span id="history-exam-name"></span></p>
                <p>éƒ¨é—¨: <span id="history-exam-department"></span></p>
                <p>æ—¥æœŸ: <span id="history-exam-date"></span></p>
                <p>æ ¡åŒº: <span id="history-exam-campus"></span></p>
                
                <div id="history-container">
                    <!-- æ›¿æ¢å†å²è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <div class="actions">
                    <button class="btn-primary" onclick="closeHistoryModal()">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®å­˜å‚¨
        let currentSemester = localStorage.getItem('currentSemester') || '25ç§‹';
        let teachers = [];
        let exams = [];
        let currentExamIndex = null;
        let selectedReplacement = null;
        let replacementMode = 'recommended'; // 'recommended' æˆ– 'manual'
        let restoreFileData = null; // å­˜å‚¨æ¢å¤æ–‡ä»¶æ•°æ®
        
        // å­¦æœŸæ•°æ®æ˜ å°„
        const semesterData = {
            '25ç§‹': { name: '2025å¹´ç§‹å­£å­¦æœŸ', start: '2025-09-01', end: '2026-01-31' },
            '26æ˜¥': { name: '2026å¹´æ˜¥å­£å­¦æœŸ', start: '2026-02-15', end: '2026-07-15' },
            '26ç§‹': { name: '2026å¹´ç§‹å­£å­¦æœŸ', start: '2026-09-01', end: '2027-01-31' },
            '27æ˜¥': { name: '2027å¹´æ˜¥å­£å­¦æœŸ', start: '2027-02-15', end: '2027-07-15' },
            '27ç§‹': { name: '2027å¹´ç§‹å­£å­¦æœŸ', start: '2027-09-01', end: '2028-01-31' },
            '28æ˜¥': { name: '2028å¹´æ˜¥å­£å­¦æœŸ', start: '2028-02-15', end: '2028-07-15' },
            '28ç§‹': { name: '2028å¹´ç§‹å­£å­¦æœŸ', start: '2028-09-01', end: '2029-01-31' },
            '29æ˜¥': { name: '2029å¹´æ˜¥å­£å­¦æœŸ', start: '2029-02-15', end: '2029-07-15' },
            '29ç§‹': { name: '2029å¹´ç§‹å­£å­¦æœŸ', start: '2029-09-01', end: '2030-01-31' },
            '30æ˜¥': { name: '2030å¹´æ˜¥å­£å­¦æœŸ', start: '2030-02-15', end: '2030-07-15' }
        };
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            initTabs();
            loadSemesterData();
            initReplacementTabs();
            updateSemesterDisplay();
        });
        
        // åŠ è½½å­¦æœŸæ•°æ®
        function loadSemesterData() {
            // ä»localStorageåŠ è½½å½“å‰å­¦æœŸçš„æ•°æ®
            const teachersData = localStorage.getItem(`teachers_${currentSemester}`);
            const examsData = localStorage.getItem(`exams_${currentSemester}`);
            
            teachers = teachersData ? JSON.parse(teachersData) : [];
            exams = examsData ? JSON.parse(examsData) : [];
            
            // æ›´æ–°UI
            renderTeachers();
            renderTeacherOptions();
            renderExams();
            initQueryOptions();
            updateTeacherCounts();
            checkTomorrowExams();
        }
        
        // ä¿å­˜å­¦æœŸæ•°æ®
        function saveSemesterData() {
            localStorage.setItem(`teachers_${currentSemester}`, JSON.stringify(teachers));
            localStorage.setItem(`exams_${currentSemester}`, JSON.stringify(exams));
            localStorage.setItem('currentSemester', currentSemester);
        }
        
        // é€‰æ‹©å­¦æœŸ
        function selectSemester() {
            const semesterSelect = document.getElementById('semester-select');
            const selectedSemester = semesterSelect.value;
            
            if (selectedSemester === currentSemester) {
                alert(`å·²ç»æ˜¯${semesterData[selectedSemester].name}`);
                return;
            }
            
            // ä¿å­˜å½“å‰å­¦æœŸæ•°æ®
            saveSemesterData();
            
            // åˆ‡æ¢åˆ°æ–°å­¦æœŸ
            currentSemester = selectedSemester;
            loadSemesterData();
            
            // æ›´æ–°UIæ˜¾ç¤º
            updateSemesterDisplay();
            
            // åˆ‡æ¢åˆ°æ•™å¸ˆç®¡ç†æ ‡ç­¾é¡µ
            switchToTab('teachers');
            
            alert(`å·²åˆ‡æ¢åˆ°${semesterData[selectedSemester].name}`);
        }
        
        // æ›´æ–°å­¦æœŸæ˜¾ç¤º
        function updateSemesterDisplay() {
            // æ›´æ–°å­¦æœŸé€‰æ‹©é¡µé¢çš„å½“å‰å­¦æœŸä¿¡æ¯
            document.getElementById('current-semester-name').textContent = semesterData[currentSemester].name;
            document.getElementById('current-semester-info').style.display = 'block';
            
            // æ›´æ–°å„é¡µé¢çš„å­¦æœŸæŒ‡ç¤ºå™¨
            const semesterIndicators = document.querySelectorAll('[id^="semester-indicator"]');
            semesterIndicators.forEach(indicator => {
                indicator.textContent = semesterData[currentSemester].name;
            });
            
            // æ›´æ–°å­¦æœŸé€‰æ‹©ä¸‹æ‹‰æ¡†
            document.getElementById('semester-select').value = currentSemester;
        }
        
        // åˆ‡æ¢åˆ°æŒ‡å®šæ ‡ç­¾é¡µ
        function switchToTab(tabName) {
            // ç§»é™¤æ‰€æœ‰activeç±»
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // å¦‚æœæ˜¯æŸ¥è¯¢æ ‡ç­¾ï¼Œåˆå§‹åŒ–æŸ¥è¯¢é€‰é¡¹
            if (tabName === 'query') {
                initQueryOptions();
            }
            
            // æ›´æ–°æ•™å¸ˆäººæ•°æ˜¾ç¤º
            updateTeacherCounts();
            
            // å¦‚æœæ˜¯ç›‘è€ƒä»»åŠ¡æ ‡ç­¾ï¼Œæ£€æŸ¥æ˜å¤©è€ƒè¯•
            if (tabName === 'exam-list') {
                checkTomorrowExams();
            }
        }
        
        // æ£€æŸ¥æ˜å¤©çš„è€ƒè¯•
        function checkTomorrowExams() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            const tomorrowExams = exams.filter(exam => exam.date === tomorrowStr);
            
            const noticeContainer = document.getElementById('tomorrow-exams-notice');
            const examsList = document.getElementById('tomorrow-exams-list');
            
            if (tomorrowExams.length > 0) {
                noticeContainer.style.display = 'block';
                examsList.innerHTML = '';
                
                tomorrowExams.forEach(exam => {
                    const examItem = document.createElement('div');
                    examItem.innerHTML = `
                        <div style="margin: 5px 0; padding: 5px; background: white; border-radius: 3px;">
                            <strong>${exam.department} - ${exam.name}</strong> (${exam.campus})
                            <br>ç›‘è€ƒæ•™å¸ˆ: ${exam.invigilators.join(', ')}
                        </div>
                    `;
                    examsList.appendChild(examItem);
                });
            } else {
                noticeContainer.style.display = 'none';
            }
        }
        
        // æ›´æ–°æ•™å¸ˆäººæ•°ç»Ÿè®¡
        function updateTeacherCounts() {
            const totalTeachers = teachers.length;
            const teachersWithRecords = teachers.filter(teacher => teacher.totalCount > 0).length;
            const teachersWithoutRecords = totalTeachers - teachersWithRecords;
            
            // æ›´æ–°æ•™å¸ˆç®¡ç†é¡µé¢
            document.getElementById('teacher-total-count').textContent = totalTeachers;
            document.getElementById('teacher-with-records-count').textContent = teachersWithRecords;
            document.getElementById('teacher-without-records-count').textContent = teachersWithoutRecords;
            document.getElementById('teacher-list-count').textContent = totalTeachers;
            
            // æ›´æ–°ç›‘è€ƒå®‰æ’é¡µé¢
            document.getElementById('available-teachers-count').textContent = totalTeachers;
            document.getElementById('total-teachers-count').textContent = totalTeachers;
            
            // æ›´æ–°æŸ¥è¯¢é¡µé¢
            document.getElementById('query-teacher-count').textContent = totalTeachers;
            
            // æ›´æ–°å¯¼å‡ºé¡µé¢
            document.getElementById('export-teacher-count').textContent = totalTeachers;
        }
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                    
                    // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                    
                    // å¦‚æœæ˜¯æŸ¥è¯¢æ ‡ç­¾ï¼Œåˆå§‹åŒ–æŸ¥è¯¢é€‰é¡¹
                    if (tab.dataset.tab === 'query') {
                        initQueryOptions();
                    }
                    
                    // æ›´æ–°æ•™å¸ˆäººæ•°æ˜¾ç¤º
                    updateTeacherCounts();
                    
                    // å¦‚æœæ˜¯ç›‘è€ƒä»»åŠ¡æ ‡ç­¾ï¼Œæ£€æŸ¥æ˜å¤©è€ƒè¯•
                    if (tab.dataset.tab === 'exam-list') {
                        checkTomorrowExams();
                    }
                });
            });
        }
        
        // åˆå§‹åŒ–æ›¿æ¢æ•™å¸ˆæ ‡ç­¾é¡µ
        function initReplacementTabs() {
            const tabs = document.querySelectorAll('.replacement-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    document.querySelectorAll('.replacement-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.replacement-content').forEach(t => t.classList.remove('active'));
                    
                    // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-content`).classList.add('active');
                    
                    // æ›´æ–°æ›¿æ¢æ¨¡å¼
                    replacementMode = tab.dataset.tab;
                    
                    // å¦‚æœåˆ‡æ¢åˆ°æ‰‹åŠ¨æ¨¡å¼ï¼Œæ›´æ–°ä¸‹æ‹‰é€‰é¡¹
                    if (replacementMode === 'manual') {
                        updateManualTeacherOptions();
                    }
                });
            });
        }
        
        // åˆå§‹åŒ–æŸ¥è¯¢é€‰é¡¹
        function initQueryOptions() {
            const teacherSelect = document.getElementById('query-teacher-select');
            teacherSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ•™å¸ˆ --</option>';
            
            if (teachers.length === 0) {
                teacherSelect.innerHTML = '<option value="">æš‚æ— æ•™å¸ˆæ•°æ®</option>';
                return;
            }
            
            // æŒ‰é¦–å­—æ¯åˆ†ç»„æ•™å¸ˆ
            const groups = groupTeachersByFirstLetter(teachers);
            
            // åˆ›å»ºå­—æ¯ç´¢å¼•
            createAlphabetIndex('query-teachers-index', groups);
            
            // æ·»åŠ æ•™å¸ˆé€‰é¡¹
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.name;
                option.textContent = teacher.name;
                teacherSelect.appendChild(option);
            });
            
            // æ¸…ç©ºæŸ¥è¯¢ç»“æœ
            document.getElementById('teacher-query-results').innerHTML = '';
            document.getElementById('exam-query-results').innerHTML = '';
            document.getElementById('department-query-results').innerHTML = '';
        }
        
        // è¿‡æ»¤æŸ¥è¯¢æ•™å¸ˆ
        function filterQueryTeachers(searchText) {
            const select = document.getElementById('query-teacher-select');
            const options = select.querySelectorAll('option');
            
            options.forEach(option => {
                if (option.value === '') return;
                
                const isMatch = option.textContent.toLowerCase().includes(searchText.toLowerCase());
                option.style.display = isMatch ? 'block' : 'none';
            });
        }
        
        // æŸ¥è¯¢æ•™å¸ˆç›‘è€ƒè®°å½•
        function queryTeacherRecords() {
            const teacherName = document.getElementById('query-teacher-select').value;
            const resultsContainer = document.getElementById('teacher-query-results');
            
            if (!teacherName) {
                resultsContainer.innerHTML = '';
                return;
            }
            
            const teacher = teachers.find(t => t.name === teacherName);
            if (!teacher) {
                resultsContainer.innerHTML = '<div class="alert alert-danger">æœªæ‰¾åˆ°è¯¥æ•™å¸ˆä¿¡æ¯</div>';
                return;
            }
            
            // æŸ¥æ‰¾è¯¥æ•™å¸ˆå‚ä¸çš„æ‰€æœ‰ç›‘è€ƒä»»åŠ¡
            const teacherExams = exams.filter(exam => 
                exam.invigilators.includes(teacher.name)
            );
            
            // æŒ‰æ—¥æœŸæ’åº
            teacherExams.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = `
                <div class="teacher-stats">
                    <div class="stat-card">
                        <div class="stat-label">æ€»ç›‘è€ƒæ¬¡æ•°</div>
                        <div class="stat-value">${teacher.totalCount || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æ—…é¡ºæ ¡åŒºç›‘è€ƒæ¬¡æ•°</div>
                        <div class="stat-value">${teacher.lvshunCount || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ¬éƒ¨æ ¡åŒºç›‘è€ƒæ¬¡æ•°</div>
                        <div class="stat-value">${(teacher.totalCount || 0) - (teacher.lvshunCount || 0)}</div>
                    </div>
                </div>
            `;
            
            if (teacherExams.length === 0) {
                html += '<div class="alert alert-info">è¯¥æ•™å¸ˆæš‚æ— ç›‘è€ƒè®°å½•</div>';
            } else {
                html += '<h4>ç›‘è€ƒè®°å½•è¯¦æƒ…ï¼š</h4>';
                
                teacherExams.forEach((exam, index) => {
                    const isCourseTeacher = exam.courseTeachers && exam.courseTeachers.includes(teacher.name);
                    const examDate = new Date(exam.date);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const isPastExam = examDate < today;
                    const isTomorrowExam = isTomorrow(exam.date);
                    
                    html += `
                        <div class="exam-record">
                            <h4>${exam.department ? exam.department + ' - ' : ''}${exam.name} 
                                ${isPastExam ? '<span class="badge badge-secondary">å·²ç»“æŸ</span>' : ''}
                                ${isTomorrowExam ? '<span class="badge badge-tomorrow">æ˜å¤©è€ƒè¯•</span>' : ''}
                            </h4>
                            <p><strong>æ—¥æœŸï¼š</strong>${exam.date}</p>
                            <p><strong>æ ¡åŒºï¼š</strong>${exam.campus}</p>
                            <p><strong>è§’è‰²ï¼š</strong>${isCourseTeacher ? 'ä»»è¯¾æ•™å¸ˆ' : 'ç›‘è€ƒæ•™å¸ˆ'}</p>
                            <p><strong>å…¶ä»–ç›‘è€ƒæ•™å¸ˆï¼š</strong>${exam.invigilators.filter(name => name !== teacher.name).join(', ') || 'æ— '}</p>
                        </div>
                    `;
                });
            }
            
            resultsContainer.innerHTML = html;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºæ˜å¤©è€ƒè¯•
        function isTomorrow(dateStr) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            return dateStr === tomorrowStr;
        }
        
        // æŸ¥è¯¢è¯¾ç¨‹ç›‘è€ƒå®‰æ’
        function queryExamArrangements() {
            const searchText = document.getElementById('query-exam-name').value.trim();
            const resultsContainer = document.getElementById('exam-query-results');
            
            if (!searchText) {
                resultsContainer.innerHTML = '';
                return;
            }
            
            // æœç´¢åŒ¹é…çš„è€ƒè¯•
            const matchedExams = exams.filter(exam => 
                exam.name.toLowerCase().includes(searchText.toLowerCase())
            );
            
            if (matchedExams.length === 0) {
                resultsContainer.innerHTML = '<div class="alert alert-info">æœªæ‰¾åˆ°åŒ¹é…çš„è¯¾ç¨‹</div>';
                return;
            }
            
            // æŒ‰æ—¥æœŸæ’åº
            matchedExams.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = `<h4>æ‰¾åˆ° ${matchedExams.length} ä¸ªåŒ¹é…çš„è¯¾ç¨‹ï¼š</h4>`;
            
            matchedExams.forEach(exam => {
                const examDate = new Date(exam.date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const isPastExam = examDate < today;
                const isTomorrowExam = isTomorrow(exam.date);
                
                html += `
                    <div class="exam-record">
                        <h4>${exam.department ? exam.department + ' - ' : ''}${exam.name} 
                            ${isPastExam ? '<span class="badge badge-secondary">å·²ç»“æŸ</span>' : ''}
                            ${isTomorrowExam ? '<span class="badge badge-tomorrow">æ˜å¤©è€ƒè¯•</span>' : ''}
                        </h4>
                        <p><strong>æ—¥æœŸï¼š</strong>${exam.date}</p>
                        <p><strong>æ ¡åŒºï¼š</strong>${exam.campus}</p>
                        <p><strong>ä»»è¯¾æ•™å¸ˆï¼š</strong>${exam.courseTeachers && exam.courseTeachers.length > 0 ? exam.courseTeachers.join(', ') : 'æ— '}</p>
                        <p><strong>ç›‘è€ƒæ•™å¸ˆï¼š</strong>${exam.invigilators.join(', ')}</p>
                        ${exam.replacementHistory && exam.replacementHistory.length > 0 ? 
                          `<p><strong>æ›¿æ¢è®°å½•ï¼š</strong>${exam.replacementHistory.length} æ¬¡ <button class="btn-info" onclick="showReplacementHistory(${exams.indexOf(exam)})">æŸ¥çœ‹è¯¦æƒ…</button></p>` : ''}
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
        }
        
        // æŸ¥è¯¢éƒ¨é—¨ç›‘è€ƒå®‰æ’
        function queryDepartmentExams() {
            const department = document.getElementById('query-department').value.trim();
            const resultsContainer = document.getElementById('department-query-results');
            
            if (!department) {
                resultsContainer.innerHTML = '';
                return;
            }
            
            // æœç´¢åŒ¹é…çš„è€ƒè¯•
            const matchedExams = exams.filter(exam => 
                exam.department && exam.department.toLowerCase().includes(department.toLowerCase())
            );
            
            if (matchedExams.length === 0) {
                resultsContainer.innerHTML = '<div class="alert alert-info">æœªæ‰¾åˆ°åŒ¹é…çš„éƒ¨é—¨ç›‘è€ƒä»»åŠ¡</div>';
                return;
            }
            
            // æŒ‰æ—¥æœŸæ’åº
            matchedExams.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = `<h4>æ‰¾åˆ° ${matchedExams.length} ä¸ªåŒ¹é…çš„éƒ¨é—¨ç›‘è€ƒä»»åŠ¡ï¼š</h4>`;
            
            matchedExams.forEach(exam => {
                const examDate = new Date(exam.date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const isPastExam = examDate < today;
                const isTomorrowExam = isTomorrow(exam.date);
                
                html += `
                    <div class="exam-record">
                        <h4>${exam.department ? exam.department + ' - ' : ''}${exam.name} 
                            ${isPastExam ? '<span class="badge badge-secondary">å·²ç»“æŸ</span>' : ''}
                            ${isTomorrowExam ? '<span class="badge badge-tomorrow">æ˜å¤©è€ƒè¯•</span>' : ''}
                        </h4>
                        <p><strong>æ—¥æœŸï¼š</strong>${exam.date}</p>
                        <p><strong>æ ¡åŒºï¼š</strong>${exam.campus}</p>
                        <p><strong>ä»»è¯¾æ•™å¸ˆï¼š</strong>${exam.courseTeachers && exam.courseTeachers.length > 0 ? exam.courseTeachers.join(', ') : 'æ— '}</p>
                        <p><strong>ç›‘è€ƒæ•™å¸ˆï¼š</strong>${exam.invigilators.join(', ')}</p>
                        ${exam.replacementHistory && exam.replacementHistory.length > 0 ? 
                          `<p><strong>æ›¿æ¢è®°å½•ï¼š</strong>${exam.replacementHistory.length} æ¬¡ <button class="btn-info" onclick="showReplacementHistory(${exams.indexOf(exam)})">æŸ¥çœ‹è¯¦æƒ…</button></p>` : ''}
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
        }
        
        // æ¸²æŸ“æ•™å¸ˆåˆ—è¡¨
        function renderTeachers() {
            const container = document.getElementById('teachers-container');
            container.innerHTML = '';
            
            if (teachers.length === 0) {
                container.innerHTML = '<div class="alert alert-info">æš‚æ— æ•™å¸ˆæ•°æ®</div>';
                updateTeacherCounts();
                return;
            }
            
            teachers.forEach((teacher, index) => {
                const item = document.createElement('div');
                item.className = 'teacher-item';
                item.innerHTML = `
                    <div>
                        <strong>${teacher.name}</strong>
                        <span class="badge badge-primary">æ€»æ¬¡æ•°: ${teacher.totalCount || 0}</span>
                        <span class="badge badge-warning">æ—…é¡ºæ¬¡æ•°: ${teacher.lvshunCount || 0}</span>
                        ${teacher.totalCount === 0 ? '<span class="badge badge-secondary">æ— è®°å½•</span>' : ''}
                    </div>
                    <button class="btn-danger" onclick="removeTeacher(${index})">åˆ é™¤</button>
                `;
                container.appendChild(item);
            });
            
            updateTeacherCounts();
        }
        
        // è·å–æ•™å¸ˆå§“åçš„é¦–å­—æ¯ï¼ˆæ”¯æŒä¸­æ–‡æ‹¼éŸ³é¦–å­—æ¯ï¼‰
        function getFirstLetter(name) {
            if (!name) return '#';
            
            // å¦‚æœæ˜¯è‹±æ–‡åï¼Œå–ç¬¬ä¸€ä¸ªå­—æ¯
            if (/^[a-zA-Z]/.test(name)) {
                return name.charAt(0).toUpperCase();
            }
            
            // å¦‚æœæ˜¯ä¸­æ–‡åï¼Œè½¬æ¢ä¸ºæ‹¼éŸ³é¦–å­—æ¯
            const firstChar = name.charAt(0);
            const unicode = firstChar.charCodeAt(0);
            
            // ä¸­æ–‡UnicodeèŒƒå›´
            if (unicode >= 19968 && unicode <= 40869) {
                // ç®€å•çš„ä¸­æ–‡æ‹¼éŸ³é¦–å­—æ¯æ˜ å°„ï¼ˆå®é™…åº”ç”¨ä¸­å¯ä»¥ä½¿ç”¨æ›´å®Œæ•´çš„æ‹¼éŸ³åº“ï¼‰
                const pinyinMap = {
                    'é˜¿': 'A', 'å…«': 'B', 'æ“¦': 'C', 'æ­': 'D', 'é¹…': 'E',
                    'å‘': 'F', 'å˜': 'G', 'å“ˆ': 'H', 'å‡»': 'J', 'å–€': 'K',
                    'æ‹‰': 'L', 'å¦ˆ': 'M', 'æ‹¿': 'N', 'å“¦': 'O', 'å•ª': 'P',
                    'ä¸ƒ': 'Q', 'ç„¶': 'R', 'æ’’': 'S', 'ä»–': 'T', 'æŒ–': 'W',
                    'è¥¿': 'X', 'å‹': 'Y', 'æ‚': 'Z'
                };
                
                // ç®€åŒ–çš„æ‹¼éŸ³é¦–å­—æ¯è·å–
                for (const [char, letter] of Object.entries(pinyinMap)) {
                    if (firstChar.localeCompare(char) >= 0) {
                        return letter;
                    }
                }
                return 'Z';
            }
            
            return '#';
        }
        
        // æŒ‰é¦–å­—æ¯åˆ†ç»„æ•™å¸ˆ
        function groupTeachersByFirstLetter(teacherList) {
            const groups = {};
            
            teacherList.forEach(teacher => {
                const letter = getFirstLetter(teacher.name);
                if (!groups[letter]) {
                    groups[letter] = [];
                }
                groups[letter].push(teacher);
            });
            
            // æŒ‰å­—æ¯é¡ºåºæ’åº
            const sortedGroups = {};
            Object.keys(groups).sort().forEach(key => {
                sortedGroups[key] = groups[key];
            });
            
            return sortedGroups;
        }
        
        // åˆ›å»ºå­—æ¯ç´¢å¼•
        function createAlphabetIndex(containerId, groups) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const letters = Object.keys(groups).sort();
            
            letters.forEach(letter => {
                const letterElement = document.createElement('div');
                letterElement.className = 'alphabet-letter';
                letterElement.textContent = letter;
                letterElement.onclick = () => {
                    scrollToLetter(containerId.replace('-index', ''), letter);
                };
                container.appendChild(letterElement);
            });
        }
        
        // æ»šåŠ¨åˆ°æŒ‡å®šå­—æ¯çš„æ•™å¸ˆç»„
        function scrollToLetter(containerId, letter) {
            const container = document.getElementById(containerId);
            const groupElement = container.querySelector(`[data-letter="${letter}"]`);
            
            if (groupElement) {
                groupElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // é«˜äº®æ˜¾ç¤ºå½“å‰å­—æ¯
                document.querySelectorAll(`#${containerId}-index .alphabet-letter`).forEach(el => {
                    el.classList.remove('active');
                });
                const targetLetter = document.querySelector(`#${containerId}-index .alphabet-letter:contains("${letter}")`);
                if (targetLetter) {
                    targetLetter.classList.add('active');
                }
            }
        }
        
        // è¿‡æ»¤æ•™å¸ˆ
        function filterTeachers(containerId, searchText) {
            const container = document.getElementById(containerId);
            const groups = container.querySelectorAll('.teacher-group');
            
            groups.forEach(group => {
                const letter = group.getAttribute('data-letter');
                const items = group.querySelectorAll('.checkbox-item');
                let hasVisibleItems = false;
                
                items.forEach(item => {
                    const teacherName = item.querySelector('label').textContent;
                    const isMatch = teacherName.toLowerCase().includes(searchText.toLowerCase());
                    item.style.display = isMatch ? 'flex' : 'none';
                    if (isMatch) hasVisibleItems = true;
                });
                
                group.style.display = hasVisibleItems ? 'block' : 'none';
            });
        }
        
        // æ¸²æŸ“æ•™å¸ˆé€‰é¡¹ï¼ˆç”¨äºå¤šé€‰å’Œä¸å¯ç”¨é€‰æ‹©ï¼‰
        function renderTeacherOptions() {
            renderTeacherCheckboxGroup('course-teachers');
            updateTeacherCounts();
        }
        
        // æ¸²æŸ“æ•™å¸ˆå¤é€‰æ¡†ç»„
        function renderTeacherCheckboxGroup(containerId) {
            const container = document.getElementById(containerId);
            const indexContainer = document.getElementById(`${containerId}-index`);
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            container.innerHTML = '';
            
            if (teachers.length === 0) {
                container.innerHTML = '<div class="alert alert-info">æš‚æ— æ•™å¸ˆæ•°æ®ï¼Œè¯·å…ˆæ·»åŠ æ•™å¸ˆ</div>';
                if (indexContainer) indexContainer.innerHTML = '';
                return;
            }
            
            // æŒ‰é¦–å­—æ¯åˆ†ç»„
            const groups = groupTeachersByFirstLetter(teachers);
            
            // åˆ›å»ºå­—æ¯ç´¢å¼•
            if (indexContainer) {
                createAlphabetIndex(`${containerId}-index`, groups);
            }
            
            // æ·»åŠ æ•™å¸ˆå¤é€‰æ¡†ï¼ˆæŒ‰å­—æ¯åˆ†ç»„ï¼‰
            Object.entries(groups).forEach(([letter, teachersInGroup]) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'teacher-group';
                groupDiv.setAttribute('data-letter', letter);
                
                const header = document.createElement('div');
                header.className = 'group-header';
                header.textContent = letter;
                groupDiv.appendChild(header);
                
                teachersInGroup.forEach(teacher => {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'checkbox-item';
                    checkbox.innerHTML = `
                        <input type="checkbox" id="${containerId}-${teacher.name}" value="${teacher.name}" 
                               onchange="updateSelectedTeachers('${containerId}', this)">
                        <label for="${containerId}-${teacher.name}">${teacher.name}</label>
                    `;
                    groupDiv.appendChild(checkbox);
                });
                
                container.appendChild(groupDiv);
            });
            
            // åˆå§‹åŒ–å·²é€‰æ•™å¸ˆæ˜¾ç¤º
            updateSelectedTeachers(containerId);
        }
        
        // æ›´æ–°å·²é€‰æ•™å¸ˆæ˜¾ç¤º
        function updateSelectedTeachers(containerId, changedCheckbox = null) {
            // è·å–å¯¹åº”çš„å·²é€‰æ•™å¸ˆæ˜¾ç¤ºåŒºåŸŸ
            const selectedContainer = document.getElementById(`selected-${containerId}`);
            if (!selectedContainer) return;
            
            // è·å–æ‰€æœ‰é€‰ä¸­çš„å¤é€‰æ¡†
            const checkboxes = document.querySelectorAll(`#${containerId} input:checked`);
            const selectedTeachers = Array.from(checkboxes).map(cb => cb.value);
            
            // æ›´æ–°å·²é€‰æ•™å¸ˆæ˜¾ç¤º
            selectedContainer.innerHTML = '';
            
            if (selectedTeachers.length === 0) {
                selectedContainer.innerHTML = '<div style="color: #999; font-style: italic;">æš‚æ— å·²é€‰æ•™å¸ˆ</div>';
            } else {
                selectedTeachers.forEach(teacherName => {
                    const tag = document.createElement('div');
                    tag.className = 'selected-teacher-tag';
                    tag.innerHTML = `
                        ${teacherName}
                        <span class="remove" onclick="deselectTeacher('${containerId}', '${teacherName}')">Ã—</span>
                    `;
                    selectedContainer.appendChild(tag);
                });
            }
            
            // å¦‚æœæ˜¯ä»»è¯¾æ•™å¸ˆé€‰æ‹©ï¼Œæ›´æ–°selectedReplacement
            if (containerId === 'manual-teachers' && changedCheckbox) {
                if (changedCheckbox.checked) {
                    const teacher = teachers.find(t => t.name === changedCheckbox.value);
                    if (teacher) {
                        selectedReplacement = teacher;
                    }
                } else {
                    selectedReplacement = null;
                }
            }
        }
        
        // å–æ¶ˆé€‰æ‹©æ•™å¸ˆ
        function deselectTeacher(containerId, teacherName) {
            const checkbox = document.getElementById(`${containerId}-${teacherName}`);
            if (checkbox) {
                checkbox.checked = false;
                updateSelectedTeachers(containerId);
            }
        }
        
        // æ·»åŠ æ•™å¸ˆ
        function addTeachers() {
            const namesText = document.getElementById('teacher-names').value;
            if (!namesText.trim()) {
                alert('è¯·è¾“å…¥æ•™å¸ˆå§“å');
                return;
            }
            
            const names = namesText.split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            
            names.forEach(name => {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const exists = teachers.some(teacher => teacher.name === name);
                if (!exists) {
                    teachers.push({
                        name: name,
                        totalCount: 0,
                        lvshunCount: 0,
                        lastCampus: null
                    });
                }
            });
            
            // ä¿å­˜å¹¶æ›´æ–°UI
            saveSemesterData();
            renderTeachers();
            renderTeacherOptions();
            document.getElementById('teacher-names').value = '';
            
            alert(`æˆåŠŸæ·»åŠ  ${names.length} åæ•™å¸ˆ`);
        }
        
        // åˆ é™¤æ•™å¸ˆ
        function removeTeacher(index) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤æ•™å¸ˆ "${teachers[index].name}" å—ï¼Ÿ`)) {
                teachers.splice(index, 1);
                saveSemesterData();
                renderTeachers();
                renderTeacherOptions();
            }
        }
        
        // æ¸…ç©ºæ•™å¸ˆåº“
        function clearTeachers() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•™å¸ˆæ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                teachers = [];
                saveSemesterData();
                renderTeachers();
                renderTeacherOptions();
            }
        }
        
        // æŒ‰æ—¥æœŸç­›é€‰ç›‘è€ƒä»»åŠ¡
        function filterExamsByDate() {
            const filterDate = document.getElementById('exam-filter-date').value;
            renderExams(filterDate);
        }
        
        // æ¸…é™¤ç›‘è€ƒä»»åŠ¡ç­›é€‰
        function clearExamFilter() {
            document.getElementById('exam-filter-date').value = '';
            renderExams();
        }
        
        // æ¸²æŸ“è€ƒè¯•åˆ—è¡¨
        function renderExams(filterDate = null) {
            const container = document.getElementById('exams-container');
            container.innerHTML = '';
            
            let filteredExams = exams;
            
            // å¦‚æœæœ‰ç­›é€‰æ—¥æœŸï¼Œè¿‡æ»¤è€ƒè¯•
            if (filterDate) {
                filteredExams = exams.filter(exam => exam.date === filterDate);
            }
            
            if (filteredExams.length === 0) {
                if (filterDate) {
                    container.innerHTML = `<div class="alert alert-info">${filterDate} æ²¡æœ‰ç›‘è€ƒä»»åŠ¡</div>`;
                } else {
                    container.innerHTML = '<div class="alert alert-info">æš‚æ— ç›‘è€ƒä»»åŠ¡</div>';
                }
                return;
            }
            
            // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€è¿‘çš„åœ¨å‰ï¼‰
            filteredExams.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            filteredExams.forEach((exam, index) => {
                const originalIndex = exams.findIndex(e => e.timestamp === exam.timestamp);
                const examCard = document.createElement('div');
                examCard.className = 'card';
                
                // åˆ¤æ–­è€ƒè¯•æ—¥æœŸæ˜¯å¦ä¸ºè¿‡å»
                const examDate = new Date(exam.date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const isPastExam = examDate < today;
                const isTomorrowExam = isTomorrow(exam.date);
                
                examCard.innerHTML = `
                    <h3>${exam.department ? exam.department + ' - ' : ''}${exam.name} - ${exam.date} - ${exam.campus} 
                        ${isPastExam ? '<span class="badge badge-secondary">å·²ç»“æŸ</span>' : ''}
                        ${isTomorrowExam ? '<span class="badge badge-tomorrow">æ˜å¤©è€ƒè¯•</span>' : ''}
                    </h3>
                    <p><strong>ä»»è¯¾æ•™å¸ˆ:</strong> ${exam.courseTeachers && exam.courseTeachers.length > 0 ? exam.courseTeachers.join(', ') : 'æ— '}</p>
                    <p><strong>ç›‘è€ƒæ•™å¸ˆ:</strong> ${exam.invigilators.join(', ')}</p>
                    <div class="actions">
                        <button class="btn-danger" onclick="removeExam(${originalIndex})">åˆ é™¤ä»»åŠ¡</button>
                        <button class="btn-warning" onclick="openReplaceModal(${originalIndex})">æ›¿æ¢æ•™å¸ˆ</button>
                        ${exam.replacementHistory && exam.replacementHistory.length > 0 ? 
                          `<button class="btn-info" onclick="showReplacementHistory(${originalIndex})">æŸ¥çœ‹æ›¿æ¢è®°å½•</button>` : ''}
                    </div>
                `;
                container.appendChild(examCard);
            });
        }
        
        // è‡ªåŠ¨æ’è€ƒ
        function arrangeInvigilation() {
            // è·å–è¡¨å•æ•°æ®
            const examDepartment = document.getElementById('exam-department').value.trim();
            const examName = document.getElementById('exam-name').value;
            const campus = document.getElementById('campus').value;
            const examDate = document.getElementById('exam-date').value;
            const invigilatorCount = parseInt(document.getElementById('invigilator-count').value);
            
            // è·å–é€‰ä¸­çš„ä»»è¯¾æ•™å¸ˆ
            const courseCheckboxes = document.querySelectorAll('#course-teachers input:checked');
            const courseTeachers = Array.from(courseCheckboxes).map(cb => cb.value);
            
            // éªŒè¯è¡¨å•
            if (!examDepartment) {
                alert('è¯·å¡«å†™è€ƒè¯•éƒ¨é—¨');
                return;
            }
            
            if (!examName || !examDate || !invigilatorCount) {
                alert('è¯·å¡«å†™å¿…å¡«å­—æ®µï¼šè€ƒè¯•åç§°ã€æ—¥æœŸå’Œç›‘è€ƒäººæ•°');
                return;
            }
            
            // ç­›é€‰å¯ç”¨æ•™å¸ˆ - ä¿®æ”¹éƒ¨åˆ†ï¼šå…è®¸ä»»è¯¾æ•™å¸ˆä¸€å¤©å¤šåœº
            let availableTeachers = teachers.filter(teacher => {
                // å¦‚æœæ˜¯ä»»è¯¾æ•™å¸ˆï¼Œå…è®¸ä¸€å¤©å¤šåœºï¼Œä¸æ£€æŸ¥å½“å¤©ç›‘è€ƒä»»åŠ¡
                if (courseTeachers.includes(teacher.name)) {
                    return true;
                }
                
                // å¯¹äºéä»»è¯¾æ•™å¸ˆï¼Œæ£€æŸ¥å½“å¤©æ˜¯å¦å·²æœ‰ç›‘è€ƒä»»åŠ¡
                const hasExamOnDate = exams.some(exam => {
                    return exam.date === examDate && exam.invigilators.includes(teacher.name);
                });
                
                return !hasExamOnDate;
            });
            
            // å¦‚æœæŒ‡å®šäº†ä»»è¯¾æ•™å¸ˆï¼Œç¡®ä¿å…¶åœ¨æ•™å¸ˆåº“ä¸­
            const unavailableCourseTeachers = [];
            courseTeachers.forEach(teacher => {
                const courseTeacherObj = teachers.find(t => t.name === teacher);
                if (!courseTeacherObj) {
                    unavailableCourseTeachers.push(teacher);
                }
            });
            
            if (unavailableCourseTeachers.length > 0) {
                alert(`ä»¥ä¸‹ä»»è¯¾æ•™å¸ˆä¸åœ¨æ•™å¸ˆåº“ä¸­: ${unavailableCourseTeachers.join(', ')}ï¼Œè¯·é‡æ–°é€‰æ‹©`);
                return;
            }
            
            // å¦‚æœå¯ç”¨æ•™å¸ˆä¸è¶³
            if (availableTeachers.length < invigilatorCount) {
                alert(`å¯ç”¨æ•™å¸ˆä¸è¶³ï¼Œéœ€è¦ ${invigilatorCount} äººï¼Œä½†åªæœ‰ ${availableTeachers.length} äººå¯ç”¨`);
                return;
            }
            
            // æ™ºèƒ½é€‰æ‹©ç›‘è€ƒæ•™å¸ˆ
            const selectedTeachers = selectInvigilators(
                availableTeachers, 
                invigilatorCount, 
                campus, 
                courseTeachers
            );
            
            // åˆ›å»ºç›‘è€ƒä»»åŠ¡
            const exam = {
                department: examDepartment,
                name: examName,
                courseTeachers: courseTeachers.length > 0 ? courseTeachers : null,
                campus,
                date: examDate,
                invigilators: selectedTeachers,
                timestamp: new Date().toISOString(),
                replacementHistory: [] // åˆå§‹åŒ–æ›¿æ¢å†å²è®°å½•
            };
            
            // æ›´æ–°æ•™å¸ˆæ•°æ®
            updateTeacherStats(selectedTeachers, campus);
            
            // ä¿å­˜è€ƒè¯•
            exams.push(exam);
            saveSemesterData();
            
            // æ›´æ–°UI
            renderExams();
            renderTeachers();
            checkTomorrowExams(); // æ›´æ–°æ˜å¤©è€ƒè¯•æé†’
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert('ç›‘è€ƒå®‰æ’æˆåŠŸï¼');
            
            // é‡ç½®è¡¨å•
            document.getElementById('exam-department').value = '';
            document.getElementById('exam-name').value = '';
            document.querySelectorAll('#course-teachers input').forEach(cb => cb.checked = false);
            updateSelectedTeachers('course-teachers');
            document.getElementById('invigilator-count').value = '2';
        }
        
        // æ™ºèƒ½é€‰æ‹©ç›‘è€ƒæ•™å¸ˆç®—æ³•
        function selectInvigilators(availableTeachers, count, campus, courseTeachers) {
            // å¤åˆ¶æ•°ç»„ä»¥å…ä¿®æ”¹åŸæ•°ç»„
            let candidates = [...availableTeachers];
            
            // å¦‚æœæœ‰ä»»è¯¾æ•™å¸ˆï¼Œä¼˜å…ˆé€‰æ‹©
            const selected = [];
            courseTeachers.forEach(courseTeacher => {
                const ctIndex = candidates.findIndex(t => t.name === courseTeacher);
                if (ctIndex > -1) {
                    selected.push(candidates[ctIndex].name);
                    candidates.splice(ctIndex, 1);
                    count--;
                }
            });
            
            // æŒ‰ç›‘è€ƒæ¬¡æ•°å’Œæ ¡åŒºæ¬¡æ•°æ’åºï¼Œä¼˜å…ˆé€‰æ‹©æ¬¡æ•°å°‘çš„
            candidates.sort((a, b) => {
                // æ€»æ¬¡æ•°ä¼˜å…ˆ
                if (a.totalCount !== b.totalCount) {
                    return a.totalCount - b.totalCount;
                }
                
                // æ—…é¡ºæ¬¡æ•°æ¬¡ä¼˜å…ˆï¼ˆå¦‚æœæ˜¯æ—…é¡ºæ ¡åŒºï¼‰
                if (campus === 'æ—…é¡º' && a.lvshunCount !== b.lvshunCount) {
                    return a.lvshunCount - b.lvshunCount;
                }
                
                // é¿å…è¿ç»­å®‰æ’æ—…é¡ºæ ¡åŒº
                if (a.lastCampus === 'æ—…é¡º' && b.lastCampus !== 'æ—…é¡º') {
                    return 1;
                }
                if (a.lastCampus !== 'æ—…é¡º' && b.lastCampus === 'æ—…é¡º') {
                    return -1;
                }
                
                // éšæœºæ’åºä½œä¸ºæœ€åæ‰‹æ®µ
                return Math.random() - 0.5;
            });
            
            // é€‰æ‹©å‰countä¸ªæ•™å¸ˆ
            for (let i = 0; i < count && i < candidates.length; i++) {
                selected.push(candidates[i].name);
            }
            
            return selected;
        }
        
        // æ›´æ–°æ•™å¸ˆç»Ÿè®¡æ•°æ®
        function updateTeacherStats(teacherNames, campus) {
            teacherNames.forEach(name => {
                const teacher = teachers.find(t => t.name === name);
                if (teacher) {
                    teacher.totalCount = (teacher.totalCount || 0) + 1;
                    if (campus === 'æ—…é¡º') {
                        teacher.lvshunCount = (teacher.lvshunCount || 0) + 1;
                    }
                    teacher.lastCampus = campus;
                }
            });
            updateTeacherCounts();
        }
        
        // åˆ é™¤ç›‘è€ƒä»»åŠ¡
        function removeExam(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç›‘è€ƒä»»åŠ¡å—ï¼Ÿ')) {
                // æ›´æ–°æ•™å¸ˆç»Ÿè®¡æ•°æ®ï¼ˆå‡å»è¿™æ¬¡ç›‘è€ƒï¼‰
                const exam = exams[index];
                exam.invigilators.forEach(name => {
                    const teacher = teachers.find(t => t.name === name);
                    if (teacher) {
                        teacher.totalCount = Math.max(0, (teacher.totalCount || 0) - 1);
                        if (exam.campus === 'æ—…é¡º') {
                            teacher.lvshunCount = Math.max(0, (teacher.lvshunCount || 0) - 1);
                        }
                    }
                });
                
                exams.splice(index, 1);
                saveSemesterData();
                renderExams();
                renderTeachers();
                checkTomorrowExams(); // æ›´æ–°æ˜å¤©è€ƒè¯•æé†’
            }
        }
        
        // æ‰“å¼€æ›¿æ¢æ•™å¸ˆæ¨¡æ€æ¡†
        function openReplaceModal(index) {
            currentExamIndex = index;
            const exam = exams[index];
            
            // å¡«å……æ¨¡æ€æ¡†åŸºæœ¬ä¿¡æ¯
            document.getElementById('modal-exam-name').textContent = exam.name;
            document.getElementById('modal-exam-department').textContent = exam.department || 'æœªè®¾ç½®';
            document.getElementById('modal-exam-date').textContent = exam.date;
            document.getElementById('modal-exam-campus').textContent = exam.campus;
            
            // æ£€æŸ¥è€ƒè¯•æ—¥æœŸæ˜¯å¦ä¸ºè¿‡å»
            const examDate = new Date(exam.date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const isPastExam = examDate < today;
            
            // æ˜¾ç¤ºæˆ–éšè—è¿‡å»è€ƒè¯•è­¦å‘Š
            const warningElement = document.getElementById('past-exam-warning');
            if (isPastExam) {
                warningElement.style.display = 'block';
            } else {
                warningElement.style.display = 'none';
            }
            
            // æ¸…ç©ºå¹¶å¡«å……è¦æ›¿æ¢çš„æ•™å¸ˆåˆ—è¡¨
            const replaceContainer = document.getElementById('replace-teachers');
            replaceContainer.innerHTML = '';
            
            // æŒ‰é¦–å­—æ¯åˆ†ç»„è¦æ›¿æ¢çš„æ•™å¸ˆ
            const replaceTeachers = exam.invigilators.map(name => {
                return teachers.find(t => t.name === name);
            }).filter(Boolean);
            
            const groups = groupTeachersByFirstLetter(replaceTeachers);
            
            // åˆ›å»ºå­—æ¯ç´¢å¼•
            createAlphabetIndex('replace-teachers-index', groups);
            
            // æ·»åŠ æ•™å¸ˆå¤é€‰æ¡†ï¼ˆæŒ‰å­—æ¯åˆ†ç»„ï¼‰
            Object.entries(groups).forEach(([letter, teachersInGroup]) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'teacher-group';
                groupDiv.setAttribute('data-letter', letter);
                
                const header = document.createElement('div');
                header.className = 'group-header';
                header.textContent = letter;
                groupDiv.appendChild(header);
                
                teachersInGroup.forEach(teacher => {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'checkbox-item';
                    checkbox.innerHTML = `
                        <input type="checkbox" id="replace-${teacher.name}" value="${teacher.name}" onchange="updateReplacementOptions()">
                        <label for="replace-${teacher.name}">${teacher.name}</label>
                    `;
                    groupDiv.appendChild(checkbox);
                });
                
                replaceContainer.appendChild(groupDiv);
            });
            
            // æ¸…ç©ºæ›¿ä»£æ•™å¸ˆé€‰é¡¹
            document.getElementById('replacement-options').innerHTML = '';
            selectedReplacement = null;
            
            // é‡ç½®æ›¿æ¢åŸå› è¾“å…¥æ¡†
            document.getElementById('replacement-reason').value = '';
            
            // é‡ç½®ä¸ºæ¨èæ¨¡å¼
            document.querySelectorAll('.replacement-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.replacement-content').forEach(content => content.classList.remove('active'));
            document.querySelector('.replacement-tab[data-tab="recommended"]').classList.add('active');
            document.getElementById('recommended-content').classList.add('active');
            replacementMode = 'recommended';
            
            // åˆå§‹åŒ–æ‰‹åŠ¨é€‰æ‹©æ•™å¸ˆé€‰é¡¹
            renderManualTeacherOptions();
            
            // æ˜¾ç¤ºæ›¿æ¢å†å²è®°å½•ï¼ˆå¦‚æœæœ‰ï¼‰
            const historyContainer = document.getElementById('replacement-history');
            const historyList = document.getElementById('replacement-history-list');
            
            if (exam.replacementHistory && exam.replacementHistory.length > 0) {
                historyContainer.style.display = 'block';
                historyList.innerHTML = '';
                
                exam.replacementHistory.forEach((record, idx) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <h4>æ›¿æ¢è®°å½• ${idx + 1}</h4>
                        <p><strong>æ—¶é—´ï¼š</strong>${new Date(record.timestamp).toLocaleString()}</p>
                        <p><strong>åŸæ•™å¸ˆï¼š</strong>${record.originalTeacher}</p>
                        <p><strong>æ–°æ•™å¸ˆï¼š</strong>${record.newTeacher}</p>
                        <p><strong>åŸå› ï¼š</strong>${record.reason}</p>
                    `;
                    historyList.appendChild(historyItem);
                });
            } else {
                historyContainer.style.display = 'none';
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('replaceModal').style.display = 'flex';
        }
        
        // æ¸²æŸ“æ‰‹åŠ¨é€‰æ‹©æ•™å¸ˆé€‰é¡¹
        function renderManualTeacherOptions() {
            const container = document.getElementById('manual-teachers');
            const indexContainer = document.getElementById('manual-teachers-index');
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            container.innerHTML = '';
            
            if (teachers.length === 0) {
                container.innerHTML = '<div class="alert alert-info">æš‚æ— æ•™å¸ˆæ•°æ®</div>';
                if (indexContainer) indexContainer.innerHTML = '';
                return;
            }
            
            // æŒ‰é¦–å­—æ¯åˆ†ç»„
            const groups = groupTeachersByFirstLetter(teachers);
            
            // åˆ›å»ºå­—æ¯ç´¢å¼•
            if (indexContainer) {
                createAlphabetIndex('manual-teachers-index', groups);
            }
            
            // æ·»åŠ æ•™å¸ˆå¤é€‰æ¡†ï¼ˆæŒ‰å­—æ¯åˆ†ç»„ï¼‰
            Object.entries(groups).forEach(([letter, teachersInGroup]) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'teacher-group';
                groupDiv.setAttribute('data-letter', letter);
                
                const header = document.createElement('div');
                header.className = 'group-header';
                header.textContent = letter;
                groupDiv.appendChild(header);
                
                teachersInGroup.forEach(teacher => {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'checkbox-item';
                    checkbox.innerHTML = `
                        <input type="checkbox" id="manual-teachers-${teacher.name}" value="${teacher.name}" 
                               onchange="updateSelectedTeachers('manual-teachers', this)">
                        <label for="manual-teachers-${teacher.name}">${teacher.name}</label>
                    `;
                    groupDiv.appendChild(checkbox);
                });
                
                container.appendChild(groupDiv);
            });
            
            // åˆå§‹åŒ–å·²é€‰æ•™å¸ˆæ˜¾ç¤º
            updateSelectedTeachers('manual-teachers');
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('replaceModal').style.display = 'none';
        }
        
        // é€‰æ‹©è¦æ›¿æ¢çš„æ•™å¸ˆåæ›´æ–°æ›¿ä»£æ•™å¸ˆé€‰é¡¹
        function updateReplacementOptions() {
            const selectedCheckboxes = document.querySelectorAll('#replace-teachers input:checked');
            const teachersToReplace = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (teachersToReplace.length === 0) {
                document.getElementById('replacement-options').innerHTML = '';
                selectedReplacement = null;
                return;
            }
            
            // è·å–è€ƒè¯•ä¿¡æ¯
            const exam = exams[currentExamIndex];
            
            // ç­›é€‰å¯ç”¨æ•™å¸ˆ - ä¿®æ”¹éƒ¨åˆ†ï¼šå…è®¸ä»»è¯¾æ•™å¸ˆä¸€å¤©å¤šåœº
            let availableTeachers = teachers.filter(teacher => {
                // æ’é™¤è¦æ›¿æ¢çš„æ•™å¸ˆ
                if (teachersToReplace.includes(teacher.name)) return false;
                
                // æ’é™¤å·²ç»æ˜¯ç›‘è€ƒçš„æ•™å¸ˆ
                if (exam.invigilators.includes(teacher.name)) return false;
                
                // å¯¹äºå·²ç»“æŸçš„è€ƒè¯•ï¼Œä¸æ£€æŸ¥å½“å¤©æ˜¯å¦æœ‰å…¶ä»–ç›‘è€ƒä»»åŠ¡
                const examDate = new Date(exam.date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const isPastExam = examDate < today;
                
                if (!isPastExam) {
                    // å¯¹äºæœªæ¥è€ƒè¯•ï¼Œå¦‚æœæ˜¯å½“å‰è€ƒè¯•çš„ä»»è¯¾æ•™å¸ˆï¼Œå…è®¸ä¸€å¤©å¤šåœº
                    if (exam.courseTeachers && exam.courseTeachers.includes(teacher.name)) {
                        // å…è®¸
                    } else {
                        // å¯¹äºéä»»è¯¾æ•™å¸ˆï¼Œæ£€æŸ¥å½“å¤©æ˜¯å¦å·²æœ‰å…¶ä»–ç›‘è€ƒä»»åŠ¡
                        const hasOtherExamOnDate = exams.some(e => {
                            return e.date === exam.date && e !== exam && e.invigilators.includes(teacher.name);
                        });
                        
                        if (hasOtherExamOnDate) return false;
                    }
                }
                
                return true;
            });
            
            // æŒ‰ç›‘è€ƒæ¬¡æ•°å’Œæ ¡åŒºæ¬¡æ•°æ’åºï¼Œä¼˜å…ˆé€‰æ‹©æ¬¡æ•°å°‘çš„
            availableTeachers.sort((a, b) => {
                // æ€»æ¬¡æ•°ä¼˜å…ˆ
                if (a.totalCount !== b.totalCount) {
                    return a.totalCount - b.totalCount;
                }
                
                // æ—…é¡ºæ¬¡æ•°æ¬¡ä¼˜å…ˆ
                if (exam.campus === 'æ—…é¡º' && a.lvshunCount !== b.lvshunCount) {
                    return a.lvshunCount - b.lvshunCount;
                }
                
                // é¿å…è¿ç»­å®‰æ’æ—…é¡ºæ ¡åŒº
                if (a.lastCampus === 'æ—…é¡º' && b.lastCampus !== 'æ—…é¡º') {
                    return 1;
                }
                if (a.lastCampus !== 'æ—…é¡º' && b.lastCampus === 'æ—…é¡º') {
                    return -1;
                }
                
                return Math.random() - 0.5;
            });
            
            // æ˜¾ç¤ºæ›¿ä»£æ•™å¸ˆé€‰é¡¹
            const optionsContainer = document.getElementById('replacement-options');
            optionsContainer.innerHTML = '';
            
            // åªæ˜¾ç¤ºå‰5ä¸ªæœ€ä½³é€‰é¡¹
            const topOptions = availableTeachers.slice(0, Math.min(5, availableTeachers.length));
            
            if (topOptions.length === 0) {
                optionsContainer.innerHTML = '<div class="alert alert-danger">æ²¡æœ‰å¯ç”¨çš„æ›¿ä»£æ•™å¸ˆ</div>';
                return;
            }
            
            topOptions.forEach(teacher => {
                const option = document.createElement('div');
                option.className = 'option-item';
                option.innerHTML = `
                    <strong>${teacher.name}</strong>
                    <div class="teacher-info">
                        <div>æ€»ç›‘è€ƒæ¬¡æ•°: ${teacher.totalCount || 0}</div>
                        <div>æ—…é¡ºç›‘è€ƒæ¬¡æ•°: ${teacher.lvshunCount || 0}</div>
                        <div>ä¸Šæ¬¡ç›‘è€ƒæ ¡åŒº: ${teacher.lastCampus || 'æ— è®°å½•'}</div>
                    </div>
                `;
                option.addEventListener('click', () => {
                    // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
                    document.querySelectorAll('.option-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    // æ·»åŠ å½“å‰é€‰æ‹©
                    option.classList.add('selected');
                    selectedReplacement = teacher;
                });
                optionsContainer.appendChild(option);
            });
        }
        
        // ç¡®è®¤æ›¿æ¢æ•™å¸ˆ
        function confirmReplacement() {
            const selectedCheckboxes = document.querySelectorAll('#replace-teachers input:checked');
            const teachersToReplace = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (teachersToReplace.length === 0) {
                alert('è¯·é€‰æ‹©è¦æ›¿æ¢çš„æ•™å¸ˆ');
                return;
            }
            
            if (!selectedReplacement) {
                alert('è¯·é€‰æ‹©æ›¿ä»£æ•™å¸ˆ');
                return;
            }
            
            const reason = document.getElementById('replacement-reason').value.trim();
            if (!reason) {
                alert('è¯·å¡«å†™æ›¿æ¢åŸå› ');
                return;
            }
            
            if (teachersToReplace.length > 1) {
                alert('ç›®å‰åªæ”¯æŒä¸€æ¬¡æ›¿æ¢ä¸€ä½æ•™å¸ˆï¼Œè¯·åªé€‰æ‹©ä¸€ä½è¦æ›¿æ¢çš„æ•™å¸ˆ');
                return;
            }
            
            const exam = exams[currentExamIndex];
            const teacherToReplace = teachersToReplace[0];
            
            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©è‡ªå·±æ›¿æ¢è‡ªå·±
            if (teacherToReplace === selectedReplacement.name) {
                alert('ä¸èƒ½ä½¿ç”¨åŒä¸€æ•™å¸ˆæ›¿æ¢è‡ªå·±');
                return;
            }
            
            // æ›´æ–°æ•™å¸ˆç»Ÿè®¡æ•°æ®
            const oldTeacher = teachers.find(t => t.name === teacherToReplace);
            if (oldTeacher) {
                oldTeacher.totalCount = Math.max(0, (oldTeacher.totalCount || 0) - 1);
                if (exam.campus === 'æ—…é¡º') {
                    oldTeacher.lvshunCount = Math.max(0, (oldTeacher.lvshunCount || 0) - 1);
                }
            }
            
            const newTeacher = teachers.find(t => t.name === selectedReplacement.name);
            if (newTeacher) {
                newTeacher.totalCount = (newTeacher.totalCount || 0) + 1;
                if (exam.campus === 'æ—…é¡º') {
                    newTeacher.lvshunCount = (newTeacher.lvshunCount || 0) + 1;
                }
                newTeacher.lastCampus = exam.campus;
            }
            
            // æ›´æ–°è€ƒè¯•ä¿¡æ¯
            const index = exam.invigilators.indexOf(teacherToReplace);
            if (index > -1) {
                exam.invigilators[index] = selectedReplacement.name;
            }
            
            // è®°å½•æ›¿æ¢å†å²
            const replacementRecord = {
                originalTeacher: teacherToReplace,
                newTeacher: selectedReplacement.name,
                reason: reason,
                timestamp: new Date().toISOString()
            };
            
            // åˆå§‹åŒ–æ›¿æ¢å†å²æ•°ç»„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!exam.replacementHistory) {
                exam.replacementHistory = [];
            }
            
            // æ·»åŠ æ›¿æ¢è®°å½•
            exam.replacementHistory.push(replacementRecord);
            
            // ä¿å­˜æ•°æ®
            saveSemesterData();
            
            // æ›´æ–°UI
            renderExams();
            renderTeachers();
            checkTomorrowExams(); // æ›´æ–°æ˜å¤©è€ƒè¯•æé†’
            
            // å…³é—­æ¨¡æ€æ¡†
            closeModal();
            
            alert('æ•™å¸ˆæ›¿æ¢æˆåŠŸï¼');
        }
        
        // æ˜¾ç¤ºæ›¿æ¢å†å²è®°å½•
        function showReplacementHistory(index) {
            const exam = exams[index];
            
            // å¡«å……æ¨¡æ€æ¡†åŸºæœ¬ä¿¡æ¯
            document.getElementById('history-exam-name').textContent = exam.name;
            document.getElementById('history-exam-department').textContent = exam.department || 'æœªè®¾ç½®';
            document.getElementById('history-exam-date').textContent = exam.date;
            document.getElementById('history-exam-campus').textContent = exam.campus;
            
            const historyContainer = document.getElementById('history-container');
            historyContainer.innerHTML = '';
            
            if (!exam.replacementHistory || exam.replacementHistory.length === 0) {
                historyContainer.innerHTML = '<div class="alert alert-info">æš‚æ— æ›¿æ¢è®°å½•</div>';
            } else {
                exam.replacementHistory.forEach((record, idx) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <h4>æ›¿æ¢è®°å½• ${idx + 1}</h4>
                        <p><strong>æ—¶é—´ï¼š</strong>${new Date(record.timestamp).toLocaleString()}</p>
                        <p><strong>åŸæ•™å¸ˆï¼š</strong>${record.originalTeacher}</p>
                        <p><strong>æ–°æ•™å¸ˆï¼š</strong>${record.newTeacher}</p>
                        <p><strong>åŸå› ï¼š</strong>${record.reason}</p>
                    `;
                    historyContainer.appendChild(historyItem);
                });
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('historyModal').style.display = 'flex';
        }
        
        // å…³é—­æ›¿æ¢å†å²æ¨¡æ€æ¡†
        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }
        
        // æ•°æ®å¤‡ä»½åŠŸèƒ½
        function backupData() {
            if (teachers.length === 0 && exams.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¤‡ä»½');
                return;
            }
            
            const backupData = {
                teachers: teachers,
                exams: exams,
                semester: currentSemester,
                backupTime: new Date().toISOString(),
                systemVersion: '1.0'
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `ç›‘è€ƒç³»ç»Ÿå¤‡ä»½_${currentSemester}_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('æ•°æ®å¤‡ä»½æˆåŠŸï¼');
        }
        
        // é¢„è§ˆæ¢å¤æ•°æ®
        function previewRestoreData() {
            const fileInput = document.getElementById('restore-file');
            const previewContainer = document.getElementById('restore-preview');
            const restoreBtn = document.getElementById('restore-btn');
            
            if (!fileInput.files.length) {
                previewContainer.style.display = 'none';
                restoreBtn.disabled = true;
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!data.teachers || !data.exams) {
                        previewContainer.innerHTML = '<div class="alert alert-danger">æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼</div>';
                        previewContainer.style.display = 'block';
                        restoreBtn.disabled = true;
                        return;
                    }
                    
                    restoreFileData = data;
                    
                    // æ˜¾ç¤ºé¢„è§ˆä¿¡æ¯
                    let html = `
                        <h4>å¤‡ä»½æ–‡ä»¶é¢„è§ˆ</h4>
                        <div class="backup-preview-item">
                            <strong>å¤‡ä»½æ—¶é—´ï¼š</strong>${data.backupTime ? new Date(data.backupTime).toLocaleString() : 'æœªçŸ¥'}
                        </div>
                        <div class="backup-preview-item">
                            <strong>å­¦æœŸï¼š</strong>${data.semester ? semesterData[data.semester].name : 'æœªçŸ¥'}
                        </div>
                        <div class="backup-preview-item">
                            <strong>æ•™å¸ˆæ•°é‡ï¼š</strong>${data.teachers.length} äºº
                        </div>
                        <div class="backup-preview-item">
                            <strong>ç›‘è€ƒä»»åŠ¡ï¼š</strong>${data.exams.length} ä¸ª
                        </div>
                    `;
                    
                    // å¦‚æœæœ‰æ•™å¸ˆï¼Œæ˜¾ç¤ºå‰å‡ ä¸ª
                    if (data.teachers.length > 0) {
                        html += `<div class="backup-preview-item">
                            <strong>æ•™å¸ˆç¤ºä¾‹ï¼š</strong>${data.teachers.slice(0, 5).map(t => t.name).join(', ')}
                            ${data.teachers.length > 5 ? `... ç­‰ ${data.teachers.length} äºº` : ''}
                        </div>`;
                    }
                    
                    previewContainer.innerHTML = html;
                    previewContainer.style.display = 'block';
                    restoreBtn.disabled = false;
                    
                } catch (error) {
                    previewContainer.innerHTML = `<div class="alert alert-danger">æ–‡ä»¶è§£æé”™è¯¯ï¼š${error.message}</div>`;
                    previewContainer.style.display = 'block';
                    restoreBtn.disabled = true;
                }
            };
            
            reader.onerror = function() {
                previewContainer.innerHTML = '<div class="alert alert-danger">æ–‡ä»¶è¯»å–å¤±è´¥</div>';
                previewContainer.style.display = 'block';
                restoreBtn.disabled = true;
            };
            
            reader.readAsText(file);
        }
        
        // æ¢å¤æ•°æ®
        function restoreData() {
            if (!restoreFileData) {
                alert('è¯·å…ˆé€‰æ‹©æœ‰æ•ˆçš„å¤‡ä»½æ–‡ä»¶');
                return;
            }
            
            if (!confirm('è­¦å‘Šï¼šæ¢å¤æ•°æ®å°†è¦†ç›–å½“å‰å­¦æœŸæ‰€æœ‰æ•°æ®ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                return;
            }
            
            // éªŒè¯æ•°æ®å®Œæ•´æ€§
            if (!Array.isArray(restoreFileData.teachers) || !Array.isArray(restoreFileData.exams)) {
                alert('å¤‡ä»½æ–‡ä»¶æ•°æ®æ ¼å¼é”™è¯¯');
                return;
            }
            
            try {
                // æ¢å¤æ•°æ®
                teachers = restoreFileData.teachers;
                exams = restoreFileData.exams;
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveSemesterData();
                
                // æ›´æ–°UI
                renderTeachers();
                renderTeacherOptions();
                renderExams();
                checkTomorrowExams(); // æ›´æ–°æ˜å¤©è€ƒè¯•æé†’
                
                // é‡ç½®æ¢å¤çŠ¶æ€
                document.getElementById('restore-file').value = '';
                document.getElementById('restore-preview').style.display = 'none';
                document.getElementById('restore-btn').disabled = true;
                restoreFileData = null;
                
                alert('æ•°æ®æ¢å¤æˆåŠŸï¼');
                
            } catch (error) {
                alert('æ•°æ®æ¢å¤å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // å¯¼å‡ºç›‘è€ƒæ•°æ®
        function exportExamData() {
            if (teachers.length === 0 && exams.length === 0) {
                alert('æ²¡æœ‰ç›‘è€ƒæ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            // æ”¶é›†æ‰€æœ‰ç›‘è€ƒè®°å½•
            const exportData = [];
            
            exams.forEach(exam => {
                exam.invigilators.forEach(teacherName => {
                    const teacher = teachers.find(t => t.name === teacherName);
                    if (teacher) {
                        exportData.push({
                            'ç›‘è€ƒæ•™å¸ˆ': teacherName,
                            'è€ƒè¯•éƒ¨é—¨': exam.department || 'æœªè®¾ç½®',
                            'è€ƒè¯•åç§°': exam.name,
                            'è€ƒè¯•æ—¥æœŸ': exam.date,
                            'æ ¡åŒº': exam.campus,
                            'æ€»æ¬¡æ•°': teacher.totalCount || 0,
                            'æ—…é¡ºæ¬¡æ•°': teacher.lvshunCount || 0,
                            'æœ¬éƒ¨æ¬¡æ•°': (teacher.totalCount || 0) - (teacher.lvshunCount || 0)
                        });
                    }
                });
            });
            
            if (exportData.length === 0) {
                alert('æ²¡æœ‰ç›‘è€ƒæ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            exportToExcel(exportData, `ç›‘è€ƒæ•°æ®_${currentSemester}`);
        }
        
        // é€šç”¨Excelå¯¼å‡ºå‡½æ•°
        function exportToExcel(data, fileName) {
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
            XLSX.writeFile(workbook, `${fileName}_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }
    </script>
</body>
</html>